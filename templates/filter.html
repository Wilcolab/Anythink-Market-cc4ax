{% extends "base.html" %}

{% block extra_head %}
<style>
    .image-viewer {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .download-button {
        background-color: white;
        color: var(--text-color);
        padding: 0.75rem 2rem;
        border: 2px solid var(--border-color);
        border-radius: 2rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .download-button:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .image-container {
        position: relative;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }
    
    .image-navigation {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 1rem;
        pointer-events: none;
    }
    
    .nav-arrow {
        background-color: white;
        border: none;
        border-radius: 50%;
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--shadow);
        pointer-events: auto;
        transition: transform 0.3s ease;
    }
    
    .nav-arrow:hover {
        transform: scale(1.1);
    }
    
    .preview-image {
        width: 100%;
        height: auto;
        border-radius: 1rem;
        box-shadow: var(--shadow);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
        margin-top: 2rem;
        max-width: 800px;
        margin: 2rem auto;
    }
    
    .filter-button {
        background-color: white;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .filter-button:hover {
        border-color: var(--primary-color);
    }
    
    .filter-button.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    @media (max-width: 768px) {
        .filter-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="image-viewer">
        <button class="download-button" id="download-button">
            DOWNLOAD
        </button>
        
        <div class="image-container">
            <img src="{{ image_data }}" alt="Filtered image" class="preview-image" id="filtered-image">
            <div class="image-navigation">
                <button class="nav-arrow" id="prev-filter">←</button>
                <button class="nav-arrow" id="next-filter">→</button>
            </div>
        </div>
        
        <div class="filter-grid">
            <div class="filter-button active" data-filter="original">ORIGINAL</div>
            {% for filter_id, filter_name in filters.items() %}
            <div class="filter-button" data-filter="{{ filter_id }}">{{ filter_id|upper }}</div>
            {% endfor %}
        </div>
        
        <div class="loading" id="loading">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v6l4 2"></path>
            </svg>
            <span>Processing Image...</span>
        </div>
        
        <input type="hidden" name="image_id" id="image-id" value="{{ image_id }}">
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.filter-button');
    const imageId = document.getElementById('image-id').value;
    const filteredImage = document.getElementById('filtered-image');
    const loadingIndicator = document.getElementById('loading');
    const downloadButton = document.getElementById('download-button');
    const prevButton = document.getElementById('prev-filter');
    const nextButton = document.getElementById('next-filter');
    
    let currentImageData = null;
    let currentFilterName = 'original';
    let currentFilterIndex = 0;
    
    // Create array of all filters including original
    const filters = ['original'].concat(Array.from(filterButtons)
        .filter(btn => btn.dataset.filter !== 'original')
        .map(btn => btn.dataset.filter));
    
    // Hide loading indicator initially
    loadingIndicator.style.display = 'none';
    
    function applyFilter(filterName) {
        if (filterName === 'original') {
            filteredImage.src = '{{ image_data }}';
            currentImageData = null;
            return;
        }
        
        // Show loading indicator
        loadingIndicator.style.display = 'flex';
        
        // Create form data
        const formData = new FormData();
        formData.append('image_id', imageId);
        formData.append('selected_filter', filterName);
        
        // Send request to apply filter
        fetch('/api/apply-filter', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            filteredImage.src = data.image_data;
            currentImageData = data.image_data;
            loadingIndicator.style.display = 'none';
        })
        .catch(error => {
            console.error('Error applying filter:', error);
            loadingIndicator.style.display = 'none';
        });
    }
    
    function updateActiveFilter(filterName) {
        filterButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filterName);
        });
        currentFilterName = filterName;
        currentFilterIndex = filters.indexOf(filterName);
    }
    
    // Handle filter button clicks
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filterName = this.dataset.filter;
            applyFilter(filterName);
            updateActiveFilter(filterName);
        });
    });
    
    // Handle navigation arrows
    prevButton.addEventListener('click', function() {
        currentFilterIndex = (currentFilterIndex - 1 + filters.length) % filters.length;
        const filterName = filters[currentFilterIndex];
        applyFilter(filterName);
        updateActiveFilter(filterName);
    });
    
    nextButton.addEventListener('click', function() {
        currentFilterIndex = (currentFilterIndex + 1) % filters.length;
        const filterName = filters[currentFilterIndex];
        applyFilter(filterName);
        updateActiveFilter(filterName);
    });
    
    // Handle download button click
    downloadButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!currentImageData && currentFilterName === 'original') {
            currentImageData = '{{ image_data }}';
        }
        
        if (!currentImageData) return;
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/download';
        form.style.display = 'none';
        
        const imageDataInput = document.createElement('input');
        imageDataInput.type = 'hidden';
        imageDataInput.name = 'image_data';
        imageDataInput.value = currentImageData;
        form.appendChild(imageDataInput);
        
        const filterNameInput = document.createElement('input');
        filterNameInput.type = 'hidden';
        filterNameInput.name = 'filter_name';
        filterNameInput.value = currentFilterName;
        form.appendChild(filterNameInput);
        
        document.body.appendChild(form);
        form.submit();
        
        setTimeout(() => {
            document.body.removeChild(form);
        }, 1000);
    });
});
</script>
{% endblock %} 